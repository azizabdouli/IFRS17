<!-- src/app/components/ppna-analytics/ppna-analytics.component.html -->

<div class="ppna-analytics-container">
  <!-- ================================================= -->
  <!-- üîç HEADER PPNA ANALYTICS IFRS17 -->
  <!-- ================================================= -->
  <div class="analytics-header mb-4">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h1 class="page-title">
          <i class="fas fa-chart-line text-primary me-3"></i>
          üîç Outil IFRS 17 - Approche PAA
        </h1>
        <p class="page-subtitle text-muted">
          Analyses avanc√©es, projections mensuelles et exports professionnels IFRS17
        </p>
      </div>
      <div class="col-md-4 text-end">
        <div class="status-badge">
          <span class="badge bg-success fs-6">
            <i class="fas fa-check-circle me-1"></i>
            Donn√©es PPNA Charg√©es
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- ================================================= -->
  <!-- üìä M√âTRIQUES RAPIDES -->
  <!-- ================================================= -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="metric-card bg-primary text-white">
        <div class="metric-icon">
          <i class="fas fa-file-contract"></i>
        </div>
        <div class="metric-content">
          <h3>{{ metriques.totalContracts | number }}</h3>
          <p>Contrats Trait√©s</p>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="metric-card bg-success text-white">
        <div class="metric-icon">
          <i class="fas fa-coins"></i>
        </div>
        <div class="metric-content">
          <h3>{{ formatCurrency(metriques.totalPrime) }}</h3>
          <p>Prime Totale</p>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="metric-card bg-info text-white">
        <div class="metric-icon">
          <i class="fas fa-shield-alt"></i>
        </div>
        <div class="metric-content">
          <h3>{{ formatCurrency(metriques.totalPPNA) }}</h3>
          <p>PPNA Total</p>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="metric-card bg-warning text-white">
        <div class="metric-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="metric-content">
          <h3>{{ formatPercentage(metriques.pctOnereux) }}</h3>
          <p>% Contrats On√©reux</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ================================================= -->
  <!-- üéõÔ∏è FILTRES SIDEBAR -->
  <!-- ================================================= -->
  <div class="row">
    <div class="col-md-3">
      <div class="filters-sidebar">
        <div class="card">
          <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">
              <i class="fas fa-filter me-2"></i>
              üéõÔ∏è Filtres
            </h5>
          </div>
          <div class="card-body">
            <!-- Filtre ann√©es -->
            <div class="filter-group mb-3">
              <label class="form-label">Ann√©es d'effet</label>
              <div class="row">
                <div class="col-6">
                  <input type="number" class="form-control form-control-sm" 
                         [(ngModel)]="filtreAnnees[0]" min="2020" max="2030">
                </div>
                <div class="col-6">
                  <input type="number" class="form-control form-control-sm" 
                         [(ngModel)]="filtreAnnees[1]" min="2020" max="2030">
                </div>
              </div>
            </div>

            <!-- Filtre produits -->
            <div class="filter-group mb-3">
              <label class="form-label">Produits (CODPROD)</label>
              <select class="form-select form-select-sm" 
                      [(ngModel)]="filtreProduits" multiple>
                <option *ngFor="let produit of produitsDisponibles" [value]="produit">
                  {{ produit }}
                </option>
              </select>
            </div>

            <!-- Actions filtres -->
            <div class="filter-actions">
              <button class="btn btn-primary btn-sm w-100 mb-2" 
                      (click)="applyFilters()">
                <i class="fas fa-search me-1"></i>
                Appliquer
              </button>
              <button class="btn btn-outline-secondary btn-sm w-100" 
                      (click)="resetFilters()">
                <i class="fas fa-undo me-1"></i>
                R√©initialiser
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ================================================= -->
    <!-- üìë ONGLETS PRINCIPAUX -->
    <!-- ================================================= -->
    <div class="col-md-9">
      <div class="analytics-tabs">
        <!-- Navigation des onglets -->
        <ul class="nav nav-tabs nav-justified mb-4">
          <li class="nav-item" *ngFor="let tab of tabs">
            <a class="nav-link" 
               [class.active]="activeTab === tab.id"
               (click)="selectTab(tab.id)">
              <i [class]="tab.icon + ' me-2'"></i>
              {{ tab.label }}
            </a>
          </li>
        </ul>

        <!-- Contenu des onglets -->
        <div class="tab-content">
          
          <!-- ================================================= -->
          <!-- üìÅ ONGLET DONN√âES -->
          <!-- ================================================= -->
          <div class="tab-pane" [class.show]="activeTab === 'donnees'" [class.active]="activeTab === 'donnees'">
            <div class="card">
              <div class="card-header">
                <h5>üìÅ √âtape 1 - Transformation des donn√©es selon IFRS 17 (PAA)</h5>
              </div>
              <div class="card-body">
                <div *ngIf="ppnaData" class="data-preview">
                  <p class="text-muted mb-3">
                    Aper√ßu des donn√©es transform√©es IFRS17 - Les calculs PAA sont appliqu√©s automatiquement
                  </p>
                  
                  <!-- Colonnes principales IFRS17 -->
                  <div class="row mb-3">
                    <div class="col-md-12">
                      <div class="alert alert-info">
                        <h6>‚úÖ Colonnes IFRS17 d√©tect√©es :</h6>
                        <div class="row">
                          <div class="col-md-3">
                            <span class="badge bg-primary me-2">MNTPRNET</span> Primes nettes
                          </div>
                          <div class="col-md-3">
                            <span class="badge bg-success me-2">MNTPPNA</span> Provisions PPNA
                          </div>
                          <div class="col-md-3">
                            <span class="badge bg-info me-2">CODPROD</span> Code produit
                          </div>
                          <div class="col-md-3">
                            <span class="badge bg-warning me-2">LRC</span> Liability Remaining Coverage
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div *ngIf="!ppnaData" class="text-center py-5">
                  <i class="fas fa-database fa-3x text-muted mb-3"></i>
                  <p class="text-muted">Chargement des donn√©es PPNA...</p>
                </div>
              </div>
            </div>
          </div>

          <!-- ================================================= -->
          <!-- ‚öôÔ∏è ONGLET PARAM√àTRES -->
          <!-- ================================================= -->
          <div class="tab-pane" [class.show]="activeTab === 'parametres'" [class.active]="activeTab === 'parametres'">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5>‚öôÔ∏è Param√©trage par produit</h5>
                <div>
                  <button class="btn btn-success btn-sm me-2" (click)="ajouterParametreProduit()">
                    <i class="fas fa-plus me-1"></i>Ajouter
                  </button>
                  <button class="btn btn-primary btn-sm" (click)="exporterParametres()">
                    <i class="fas fa-download me-1"></i>Exporter CSV
                  </button>
                </div>
              </div>
              <div class="card-body">
                <p class="text-muted mb-4">
                  Configurez les param√®tres DAC, patterns de service et √©ligibilit√© PAA > 12 mois par produit
                </p>
                
                <div class="table-responsive">
                  <table class="table table-bordered table-hover">
                    <thead class="table-primary">
                      <tr>
                        <th>Code Produit</th>
                        <th>DAC %</th>
                        <th>√âligible PAA</th>
                        <th class="text-center" colspan="12">Pattern 12 mois</th>
                        <th>Actions</th>
                      </tr>
                      <tr>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th *ngFor="let i of [1,2,3,4,5,6,7,8,9,10,11,12]" class="text-center">M{{i}}</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let param of parametresProduits; let idx = index">
                        <td>
                          <input type="text" class="form-control form-control-sm" 
                                 [(ngModel)]="param.CODPROD">
                        </td>
                        <td>
                          <input type="number" class="form-control form-control-sm" 
                                 [(ngModel)]="param.DAC_pct" step="0.01" min="0" max="1">
                        </td>
                        <td class="text-center">
                          <input type="checkbox" class="form-check-input" 
                                 [(ngModel)]="param.Eligible_PAA">
                        </td>
                        <td *ngFor="let month of ['M1','M2','M3','M4','M5','M6','M7','M8','M9','M10','M11','M12']">
                          <input type="number" class="form-control form-control-sm" 
                                 [(ngModel)]="param[month]" step="0.001" min="0" max="1">
                        </td>
                        <td class="text-center">
                          <button class="btn btn-danger btn-sm" (click)="supprimerParametreProduit(idx)">
                            <i class="fas fa-trash"></i>
                          </button>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                
                <div class="alert alert-warning">
                  <i class="fas fa-info-circle me-2"></i>
                  <strong>Note :</strong> Les patterns mensuels doivent sommer √† 1.0 pour chaque produit. 
                  La normalisation automatique sera appliqu√©e si n√©cessaire.
                </div>
              </div>
            </div>
          </div>

          <!-- ================================================= -->
          <!-- üìä ONGLET ANALYSES -->
          <!-- ================================================= -->
          <div class="tab-pane" [class.show]="activeTab === 'analyses'" [class.active]="activeTab === 'analyses'">
            <div class="analyses-content">
              <!-- Loading state -->
              <div *ngIf="isLoading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Calcul en cours...</span>
                </div>
                <p class="mt-3">G√©n√©ration des analyses...</p>
              </div>

              <!-- Analyses content -->
              <div *ngIf="!isLoading">
                <!-- Scatter Plot PPNA -->
                <div class="card mb-4">
                  <div class="card-header">
                    <h5>üìä PPNA comptable vs PPNA IFRS 17</h5>
                  </div>
                  <div class="card-body">
                    <div class="chart-container" style="height: 400px;">
                      <canvas id="scatterChart"></canvas>
                    </div>
                    <p class="text-muted mt-2">
                      <i class="fas fa-info-circle me-1"></i>
                      Comparaison pond√©r√©e par prime entre PPNA comptable et IFRS17. 
                      La ligne rouge repr√©sente l'√©galit√© parfaite.
                    </p>
                  </div>
                </div>

                <!-- Distribution LRC -->
                <div class="card mb-4">
                  <div class="card-header">
                    <h5>üìà Distribution des LRC</h5>
                  </div>
                  <div class="card-body">
                    <div class="chart-container" style="height: 400px;">
                      <canvas id="lrcChart"></canvas>
                    </div>
                    <p class="text-muted mt-2">
                      <i class="fas fa-info-circle me-1"></i>
                      Distribution des Liability for Remaining Coverage. 
                      Les valeurs n√©gatives indiquent des contrats potentiellement on√©reux.
                    </p>
                  </div>
                </div>

                <!-- Revenus mensuels -->
                <div class="card mb-4">
                  <div class="card-header">
                    <h5>üìÜ Revenus IFRS 17 reconnus - agr√©gation mensuelle</h5>
                  </div>
                  <div class="card-body">
                    <div class="chart-container" style="height: 400px;">
                      <canvas id="revenueChart"></canvas>
                    </div>
                    <p class="text-muted mt-2">
                      <i class="fas fa-info-circle me-1"></i>
                      √âvolution mensuelle des revenus IFRS17 (proxy liss√©) bas√©e sur les patterns de service.
                    </p>
                  </div>
                </div>

                <!-- Vue Groupe IFRS17 -->
                <div class="card">
                  <div class="card-header">
                    <h5>üè∑Ô∏è Vue Groupe IFRS-17 (Portfolio √ó Cohorte √ó On√©reux)</h5>
                  </div>
                  <div class="card-body">
                    <div class="row" *ngIf="ppnaData?.['analyse_segments']">
                      <div class="col-md-4 mb-3" *ngFor="let segment of ppnaData?.['analyse_segments'] || []">
                        <div class="card border-primary">
                          <div class="card-body">
                            <h6 class="card-title">{{ segment.segment }}</h6>
                            <div class="metrics-grid">
                              <div class="metric-item">
                                <span class="metric-label">LRC:</span>
                                <span class="metric-value">{{ formatCurrency(segment.provisions) }}</span>
                              </div>
                              <div class="metric-item">
                                <span class="metric-label">Contrats:</span>
                                <span class="metric-value">{{ segment.nombre_contrats | number }}</span>
                              </div>
                              <div class="metric-item">
                                <span class="metric-label">Revenue:</span>
                                <span class="metric-value">{{ formatCurrency(segment.primes) }}</span>
                              </div>
                              <div class="metric-item">
                                <span class="metric-label">Ratio:</span>
                                <span class="metric-value">{{ formatPercentage(segment.ratio_acquisition) }}</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ================================================= -->
          <!-- üßÆ ONGLET PROJECTION -->
          <!-- ================================================= -->
          <div class="tab-pane" [class.show]="activeTab === 'projection'" [class.active]="activeTab === 'projection'">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5>üßÆ Projection mensuelle EXACTE (par contrat)</h5>
                <button class="btn btn-success btn-sm" (click)="exporterProjection()">
                  <i class="fas fa-download me-1"></i>
                  Exporter Projection CSV
                </button>
              </div>
              <div class="card-body">
                <p class="text-muted mb-4">
                  Utilise les patterns saisis dans l'onglet Param√®tres. DAC amortie uniforme par d√©faut.
                </p>

                <!-- Param√®tres projection -->
                <div class="row mb-4">
                  <div class="col-md-6">
                    <label class="form-label">Ann√©es d'effet √† inclure (projection)</label>
                    <div class="row">
                      <div class="col-6">
                        <input type="number" class="form-control" 
                               [(ngModel)]="anneesProjection[0]" min="2020" max="2030">
                      </div>
                      <div class="col-6">
                        <input type="number" class="form-control" 
                               [(ngModel)]="anneesProjection[1]" min="2020" max="2030">
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6 d-flex align-items-end">
                    <button class="btn btn-primary" (click)="calculateProjection()">
                      <i class="fas fa-calculator me-2"></i>
                      Calculer Projection
                    </button>
                  </div>
                </div>

                <!-- Loading state -->
                <div *ngIf="isLoading" class="text-center py-5">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Calcul projection...</span>
                  </div>
                  <p class="mt-3">Calcul de la projection mensuelle exacte...</p>
                </div>

                <!-- R√©sultats projection -->
                <div *ngIf="!isLoading && projectionData.length > 0">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover">
                      <thead class="table-primary">
                        <tr>
                          <th>Mois</th>
                          <th>Revenue Mensuel (TND)</th>
                          <th>DAC Amortissement (TND)</th>
                          <th>Code Produit</th>
                          <th>Cohorte</th>
                          <th>On√©reux</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let proj of projectionData.slice(0, 20)">
                          <td>{{ proj.mois }}</td>
                          <td>{{ formatCurrency(proj.revenue_mois) }}</td>
                          <td>{{ formatCurrency(proj.dac_amort_mois) }}</td>
                          <td>
                            <span class="badge bg-secondary">{{ proj.CODPROD }}</span>
                          </td>
                          <td>{{ proj.Cohorte }}</td>
                          <td>
                            <span class="badge" [class.bg-danger]="proj.Onereux" [class.bg-success]="!proj.Onereux">
                              {{ proj.Onereux ? 'Oui' : 'Non' }}
                            </span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  
                  <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Affichage des 20 premi√®res lignes. Total : {{ projectionData.length | number }} lignes projet√©es.
                  </div>
                </div>

                <div *ngIf="!isLoading && projectionData.length === 0" class="text-center py-5">
                  <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                  <p class="text-muted">Cliquez sur "Calculer Projection" pour g√©n√©rer les donn√©es</p>
                </div>
              </div>
            </div>
          </div>

          <!-- ================================================= -->
          <!-- ‚¨áÔ∏è ONGLET EXPORTS -->
          <!-- ================================================= -->
          <div class="tab-pane" [class.show]="activeTab === 'exports'" [class.active]="activeTab === 'exports'">
            <div class="card">
              <div class="card-header">
                <h5>‚¨áÔ∏è Exports professionnels</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <!-- Export Excel -->
                  <div class="col-md-4 mb-3">
                    <div class="export-card">
                      <div class="export-icon">
                        <i class="fas fa-file-excel text-success fa-3x"></i>
                      </div>
                      <h6>Export Excel</h6>
                      <p class="text-muted">Multi-onglets avec donn√©es, projections et analyses</p>
                      <button class="btn btn-success w-100" (click)="exporterExcel()">
                        <i class="fas fa-download me-2"></i>
                        T√©l√©charger Excel
                      </button>
                    </div>
                  </div>

                  <!-- Export CSV -->
                  <div class="col-md-4 mb-3">
                    <div class="export-card">
                      <div class="export-icon">
                        <i class="fas fa-file-csv text-primary fa-3x"></i>
                      </div>
                      <h6>Export CSV (ZIP)</h6>
                      <p class="text-muted">Fichiers s√©par√©s pour grands volumes</p>
                      <button class="btn btn-primary w-100" (click)="exporterProjection()">
                        <i class="fas fa-download me-2"></i>
                        T√©l√©charger ZIP
                      </button>
                    </div>
                  </div>

                  <!-- Export PDF -->
                  <div class="col-md-4 mb-3">
                    <div class="export-card">
                      <div class="export-icon">
                        <i class="fas fa-file-pdf text-danger fa-3x"></i>
                      </div>
                      <h6>Rapport PDF</h6>
                      <p class="text-muted">Rapport de synth√®se IFRS17</p>
                      <button class="btn btn-danger w-100" (click)="exporterPDF()">
                        <i class="fas fa-download me-2"></i>
                        G√©n√©rer PDF
                      </button>
                    </div>
                  </div>
                </div>

                <div class="alert alert-success mt-4">
                  <i class="fas fa-check-circle me-2"></i>
                  <strong>‚úÖ Exports pr√™ts.</strong> 
                  Tous les formats supportent les gros volumes avec optimisations.
                </div>
              </div>
            </div>
          </div>

          <!-- ================================================= -->
          <!-- üìí ONGLET REGISTRE -->
          <!-- ================================================= -->
          <div class="tab-pane" [class.show]="activeTab === 'registre'" [class.active]="activeTab === 'registre'">
            <div class="card">
              <div class="card-header">
                <h5>üìí Registre des Assumptions & Contexte</h5>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-bordered">
                    <thead class="table-secondary">
                      <tr>
                        <th>√âl√©ment</th>
                        <th>Valeur</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td><strong>Date de gel</strong></td>
                        <td>{{ getCurrentDateTime() }}</td>
                      </tr>
                      <tr>
                        <td><strong>Source donn√©es</strong></td>
                        <td>Ppna (4).xlsx</td>
                      </tr>
                      <tr>
                        <td><strong>Nb contrats</strong></td>
                        <td>{{ metriques.totalContracts | number }}</td>
                      </tr>
                      <tr>
                        <td><strong>Nb produits</strong></td>
                        <td>{{ produitsDisponibles.length | number }}</td>
                      </tr>
                      <tr>
                        <td><strong>DAC moyen</strong></td>
                        <td>10.00%</td>
                      </tr>
                      <tr>
                        <td><strong>Hypoth√®se pattern</strong></td>
                        <td>Pattern saisi par produit (onglet Param√®tres), uniforme si vide</td>
                      </tr>
                      <tr>
                        <td><strong>√âligibilit√© PAA > 12m</strong></td>
                        <td>Flag 'Eligible_PAA' dans param√®tres (documentation requise si True)</td>
                      </tr>
                      <tr>
                        <td><strong>Devise</strong></td>
                        <td>Dinar Tunisien (TND)</td>
                      </tr>
                      <tr>
                        <td><strong>M√©thode IFRS17</strong></td>
                        <td>Premium Allocation Approach (PAA)</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div class="mt-3">
                  <button class="btn btn-primary" (click)="exporterParametres()">
                    <i class="fas fa-download me-2"></i>
                    Exporter registre (CSV)
                  </button>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>